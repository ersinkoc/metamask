<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.6.0/dist/css/bootstrap.min.css">
    <script src="https://cdn.jsdelivr.net/npm/web3@latest/dist/web3.min.js"></script>
    <script src="https://unpkg.com/@metamask/detect-provider/dist/detect-provider.min.js"></script>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <title>Metamask Test</title>
</head>

<body>
    <style>
        .meta-gray {
            -webkit-filter: grayscale(1);
            filter: grayscale(1);
        }

        .meta-normal {
            -webkit-filter: grayscale(0);
            filter: grayscale(0);
        }
    </style>

    <div class="container">
        <div class="row text-center">
            <div class="col-md-12">
                <img id="metaicon" class="meta-gray" width="150" height="150" src="metamask-fox.png" alt="">
            </div>
        </div>
        <div style="margin-top: 30px;" class="row text-center">
            <div class="col-md-12">
                <div id="div_networkid">Network ID: <span id="networkid"></span></div>
                <br />
                <button id="addMain" class="btn btn-success">Switch to OXO Chain Main</button>
                <button id="addTest" class="btn btn-secondary">Switch to OXO Chain Test</button>
                <br />
                <br />

                <div><button id="enableMetamask" class="btn btn-danger">Connect with Metamask</button>
                </div>
                <div id="div_balance">Balance: <span id="balance">0</span></div>
                <div id="div_blocknumber">Last Block: <span id="blocknumber">...</span></div>

            </div>
        </div>

        <div class="row text-center">
            <div class="col-md-12">
                <span id="status"></span>
            </div>
        </div>
        <section class="contract-section hidden">
            <div style="margin-top: 30px;" class="row text-center">
                <div class="col-md-8">
                    <input id="contractaddress" type="text" class="form-control" value="0x">
                </div>
                <div class="col-md-4">
                    <button id="getTokenInfo" class="btn btn-primary btn-block">Get Token Info</button>
                </div>
                <div class="col-md-12">0x01cE423BeD8Eca832Ffa9CD9aE8A3aB5a0FcBd10,
                    0x54b45f2b3Db26D6D68A08B85AdDb01b70c02BD61</div>
            </div>
            <div style="margin-top: 30px;" class="row" id="tokenInfo">
                <div class="col-md-12">
                    <h3>Token Info</h3>
                    <span>Name: <i id="getName"></i></span><br />
                    <span>Symbol: <i id="getSymbol"></i></span><br />
                    <span>Decimals: <i id="getDecimals"></i></span><br />
                    <span>Address: <i id="contractAddress"></i></span><br /><br />
                    <button id="addToMetamask" class="btn btn-warning"><span id="btnToken">Add Token to
                            Metamask</span></button>
                </div>
            </div>
        </section>


        <section class="blacklist-section">
            <div style="margin-top: 30px;" class="row text-center">
                <div class="col-md-12">
                    Contract: 0xa844347E8DdDeE34a5c014626644CBa30231b6e2
                </div>
                <div class="col-md-8">
                    <input id="toAddress" type="text" class="form-control" value="0x">
                </div>
                <div class="col-md-4">
                    <button id="toBlacklist" class="btn btn-danger btn-block">add to blacklist</button>
                    <button id="removeBlacklist" class="btn btn-secondary btn-block">remove</button>
                </div>
                <div class="col-md-6" style="margin-top: 30px;"><span id="totalRewardedSpan">0</span></div>
                <div class="col-md-6" style="margin-top: 30px;"><button id="totalRewarded"
                        class="btn btn-primary btn-block">totalRewarded</button></div>

            </div>
        </section>


    </div>
    <script>

        let currentAccount = null;
        let web3;
        let contractAddress;
        let chainId = 0;

        let erc20ABI;
        let erc20Token;

        let contractSymbol;
        let contractDecimals;
        let contractFirst;
        let contractName;

        let testContractAddress = '0xa844347E8DdDeE34a5c014626644CBa30231b6e2';
        let stakeTokenABI;

        const NetworkInfo = {
            1: {
                "chainName": "Ethereum Main Net",
                "chainId": 0x1,
                "name": "Ether",
                "symbol": "ETH",
                "decimals": 18,
                "rpcUrls": { 0: "https://mainnet.infura.io/v3/b38821aa1dfb47fe8bf1adad521e1afc" },
                "blockExplorerUrls": { 0: "https://etherscan.io" }
            },
            1881: {
                "chainName": "OXO Chain Main",
                "chainId": 0x759,
                "name": "OXO",
                "symbol": "OXO",
                "decimals": 18,
                "rpcUrls": { 0: "https://rpc.oxochain.com" },
                "blockExplorerUrls": { 0: "https://explorer.oxochain.com" }
            },
            91881: {
                "chainName": "OXO Chain Test",
                "chainId": 0x166E9,
                "name": "Test OXO",
                "symbol": "TOXO",
                "decimals": 18,
                "rpcUrls": { 0: "https://rpc.testnet.oxochain.com" },
                "blockExplorerUrls": { 0: "https://explorer.testnet.oxochain.com" }
            }
        }

        function handleDisconnect() {
            console.log('handleDisconnect()');
        }

        function handleChainChanged(chain) {
            console.log('handleChainChanged(' + chain + ')');
            if (chainId != chain) {
                window.location.reload();
            }
            chainId = chain;
        }

        function handleAccountsChanged(accounts) {
            console.log('handleAccountsChanged(' + accounts + ')');

            if (accounts.length === 0) {
                console.log('Please connect to MetaMask.');
                $('#enableMetamask').html('Connect with Metamask')
                $('#balance').html('...');
                $('#networkid').html('...');
            } else if (accounts[0] !== currentAccount) {
                currentAccount = accounts[0];
                $('#enableMetamask').html(currentAccount);
                $('#status').html('');
                if (currentAccount != null) {
                    // Set the button label
                    $('#enableMetamask').html(currentAccount);
                    getBalance(currentAccount);
                    getChainId();
                }
            }
            console.log('WalletAddress in HandleAccountChanged [' + currentAccount + ']')
        }

        function connect() {
            console.log('connect()')
            try {
                web3 = new Web3(window.ethereum);
                //web3 = new Web3(new Web3.providers.HttpProvider("https://rpc.testnet.oxochain.com"));
                getChainId();
                getBlockNumber();
            } catch (error) {
                alert(error)
            }

            ethereum.request({ method: 'net_version' }).then(handleChainChanged)
                .catch((err) => {
                    console.error(err);
                });

            ethereum.request({ method: 'eth_requestAccounts' }).then(handleAccountsChanged)
                .catch((err) => {
                    if (err.code === 4001) {
                        // EIP-1193 userRejectedRequest error
                        // If this happens, the user rejected the connection request.
                        console.log('Please connect to MetaMask.');
                        $('#status').html('You refused to connect Metamask')
                    } else {
                        console.error(err);
                    }
                });
        }

        function detectMetaMask() {
            console.log('detectMetaMask()');
            if (typeof window.ethereum !== 'undefined') {
                ethereum.on('accountsChanged', handleAccountsChanged);
                ethereum.on('chainChanged', handleChainChanged);
                ethereum.on('disconnet', handleDisconnect);
                console.log(ethereum);
                return true
            } else {
                console.log('Metamask is not installed!');
                return false
            }
        }

        async function getBlockNumber() {
            console.log('getBlockNumber()');
            const latestBlockNumber = await web3.eth.getBlockNumber()
            /*	try {
                    var latestBlockNumber = await ethereum.request({
                    method: 'eth_blockNumber'
                    });
                } catch (error) {
                    console.log('Error: ' + error);
                }
            */
            console.log('Block Number: ' + latestBlockNumber)
            $('#blocknumber').html(latestBlockNumber);
            return latestBlockNumber
        }

        async function getChainId() {
            console.log('getChainId()');
            chainId = await web3.eth.net.getId() // From web3 rpc
            //chainId = await window.ethereum.networkVersion; // From Metamask
            console.log('Network ID: ' + chainId)

            if (NetworkInfo[chainId] != undefined) {
                $('#networkid').html(chainId + ' (' + NetworkInfo[chainId].chainName + ')');
            } else {
                $('#networkid').html(chainId + ' (Unknown Network)');
            }
            return chainId
        }

        async function getTokenInfo() {
            console.log('getTokenInfo')
            _contractAddress = $('#contractaddress').val().trim();
            $('#getName').html('');
            $('#getSymbol').html('');
            $('#getDecimals').html('');
            $('#getName').html('');
            $('#btnToken').html('Add Token to Metamask');
            $('#contractAddress').html('');
            $('#tokenInfo').hide();
            try {
                web3.eth.getCode(_contractAddress).then(function (result) {
                    if (result == '0x') { $('#contractaddress').val('0x'); }
                    if (result != '0x') {
                        var contractFirst = new web3.eth.Contract(erc20ABI, _contractAddress);
                        erc20Token = contractFirst;
                        contractAddress = _contractAddress;
                        $('#tokenInfo').show();
                        $('#contractAddress').html(contractAddress);

                        getSymbol();
                        getDecimals();
                        getName();
                    }
                })
            } catch (error) {
                console.log('Error: ' + error);
            }
        }

        async function getSymbol() {
            console.log('getSymbol')
            try {
                erc20Token.methods.symbol().call().then(function (result) {
                    $('#getSymbol').html(result);
                    contractSymbol = result;
                });
            } catch (error) {
                console.log('Error: ' + error);
            }
        }

        async function getDecimals() {
            console.log('getDecimals()')
            try {
                erc20Token.methods.decimals().call().then(function (result) {
                    $('#getDecimals').html(result);
                    contractDecimals = result;
                });
            } catch (error) {
                console.log('Error: ' + error);
            }
        }

        async function getName() {
            console.log('getName()')
            try {
                erc20Token.methods.name().call().then(function (result) {
                    $('#btnToken').html('Add  \"' + result + '\" to Metamask');
                    $('#getName').html(result);
                    contractName = result;
                });
            } catch (error) {
                console.log('Error: ' + error);
            }
        }

        async function addBlacklist() {
            console.log('addBlacklist()');
            toAddress = $('#toAddress').val().trim();
            if (web3.utils.isAddress(toAddress)) {
                try {
                    web3.eth.getCode(toAddress).then(function (result) {
                        if (result == '0x') {
                            var c = new web3.eth.Contract(stakeTokenABI, testContractAddress);
                            c.methods.addToBlacklist(toAddress)
                                .send({ from: web3.givenProvider.selectedAddress })
                                .then(function (result) {
                                    console.log(result);
                                });
                        } else {
                            console.log('Address is a contract')
                            $('#toAddress').val('0xdead000123');
                        }
                    });
                } catch (error) {
                    $('#toAddress').val('0xdead000999');
                    console.log('Error: ' + error);
                }
            }
        }

        async function removeBlacklist() {
            console.log('removeBlacklist()');
            toAddress = $('#toAddress').val().trim();
            if (web3.utils.isAddress(toAddress)) {
                try {
                    web3.eth.getCode(toAddress).then(function (result) {
                        if (result == '0x') {
                            var c = new web3.eth.Contract(stakeTokenABI, testContractAddress);
                            c.methods.removeFromBlacklist(toAddress)
                                .send({ from: web3.givenProvider.selectedAddress })
                                .then(function (result) {
                                    console.log(result);
                                });
                        } else {
                            console.log('Address is a contract')
                            $('#toAddress').val('0xdead000123');
                        }
                    });
                } catch (error) {
                    $('#toAddress').val('0xdead000999');
                    console.log('Error: ' + error);
                }
            }
        }

        async function totalRewarded() {
            console.log('totalRewarded()');
            try {
                var c = new web3.eth.Contract(stakeTokenABI, testContractAddress);
                c.methods.totalRewarded()
                    .call()
                    .then(function (result) {
                        $('#totalRewardedSpan').html(web3.utils.fromWei(result, 'ether'));
                        console.log(result);
                    });
            } catch (error) {
                console.log('Error: ' + error);
            }
        }

        async function getBalance() {
            console.log('getBalance()');
            var getBalanceResult = 0;
            try {
                web3.eth.getBalance(currentAccount).then(function (result) {
                    var symbol = 'MONEY';
                    if (NetworkInfo[chainId] != undefined) symbol = NetworkInfo[chainId].symbol;
                    $('#balance').html(web3.utils.fromWei(result, 'ether') + ' ' + symbol)
                });
            } catch (error) {
                console.log('Error: ' + error);
            }
            return getBalanceResult;
        }

        async function addToMetamask() {
            console.log('addToMetamask()');
            const tokenAddress = contractAddress;
            const tokenSymbol = contractSymbol;
            const tokenDecimals = contractDecimals;
            const tokenImage = '';

            try {
                // wasAdded is a boolean. Like any RPC method, an error may be thrown.
                const wasAdded = await ethereum.request({
                    method: 'wallet_watchAsset',
                    params: {
                        type: 'ERC20', // Initially only supports ERC20, but eventually more!
                        options: {
                            address: tokenAddress, // The address that the token is at.
                            symbol: tokenSymbol, // A ticker symbol or shorthand, up to 5 chars.
                            decimals: tokenDecimals, // The number of decimals in the token
                            image: tokenImage, // A string url of the token logo
                        },
                    }
                });

                if (wasAdded) {
                    console.log('Thanks for your interest!');
                } else {
                    console.log('Your loss!');
                }
            } catch (error) {
                console.log(error);
            }
        }

        async function addNetworkToMetaMask(_chainId) {
            console.log('addNetworkToMetaMask(Arguments)');
            console.log(arguments);
            if (NetworkInfo[_chainId] != undefined) {
                var HexChainId = web3.utils.toHex(_chainId); //
                try {
                    await ethereum.request({
                        method: 'wallet_switchEthereumChain',
                        params: [{ chainId: HexChainId }], // Hexadecimal version of ..., prefixed with 0x
                    });
                } catch (error) {
                    if (error.code === 4902) {
                        try {
                            await ethereum.request({
                                method: 'wallet_addEthereumChain',
                                params: [{
                                    chainId: HexChainId, // Hexadecimal version of ... , prefixed with 0x
                                    chainName: NetworkInfo[_chainId].chainName,
                                    nativeCurrency: {
                                        name: NetworkInfo[_chainId].name,
                                        symbol: NetworkInfo[_chainId].symbol,
                                        decimals: NetworkInfo[_chainId].decimals,
                                    },
                                    rpcUrls: [NetworkInfo[_chainId].rpcUrls[0]],
                                    blockExplorerUrls: [NetworkInfo[_chainId].blockExplorerUrls[0]],
                                    iconUrls: [NetworkInfo[_chainId].iconUrls],
                                }],
                            });
                        } catch (addError) {
                            console.log('Did not add network');
                        }
                    }
                }
            }
        }

        // async function addOxoNetwork() {
        //     console.log('addOxoNetwork(1881)');
        //     addNetworkToMetaMask(1881);
        // }

        // async function addOxoTestnetNetwork() {
        //     console.log('addOxoTestnetNetwork(91881)');
        //     addNetworkToMetaMask(91881);
        // }
    </script>

    <script>
        $.getJSON("ERC20.json", function (result) {
            erc20ABI = result.abi
        });

        $.getJSON("StakeToken.json", function (result) {
            stakeTokenABI = result.abi
        });

        $(document).ready(function () {
            m = detectMetaMask()
            if (m) {
                $('#metaicon').removeClass('meta-gray')
                $('#metaicon').addClass('meta-normal')
                $('#enableMetamask').attr('disabled', false)
                connect() // Make sure the connected wallet is being returned
            } else {
                $('#enableMetamask').attr('disabled', true)
                $('#metaicon').removeClass('meta-normal')
                $('#metaicon').addClass('meta-gray')
            }

            $('#tokenInfo').hide();

            $('#enableMetamask').click(function () {
                connect()
            });

            $('#getTokenInfo').click(function () {
                getTokenInfo()
            });

            $('#addToMetamask').click(function () {
                addToMetamask()
            });

            $('#addMain').click(function () {
                addNetworkToMetaMask(1881)
            });

            $('#addTest').click(function () {
                addNetworkToMetaMask(91881)
            });

            $('#toBlacklist').click(function () {
                addBlacklist()
            });

            $('#removeBlacklist').click(function () {
                removeBlacklist()
            });

            $('#totalRewarded').click(function () {
                totalRewarded()
            });

            // try {     
            //     //web3 = new Web3(new Web3.providers.HttpProvider("https://rpc.testnet.oxochain.com"));
            //     getChainId();
            //     getBlockNumber();
            // } catch (error) {
            //     alert(error)
            // }  
        })
    </script>
</body>

</html>